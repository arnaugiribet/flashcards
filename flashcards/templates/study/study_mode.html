{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)]">
    <div class="w-full max-w-2xl">
        <div class="bg-[#f4f6f5] rounded-lg shadow-md p-8">
            <div class="text-center mb-6">
                <h2 class="text-[#9daca2] text-2xl font-bold mb-2">Study Mode</h2>
                <p class="text-gray-600">Cards remaining: <span id="cards-remaining">{{ total_due_cards }}</span></p>
            </div>

            <!-- Flashcard container -->
            <div id="flashcard-container" class="bg-white rounded-lg p-6 shadow-inner mb-6 transition-all duration-300">
                <div id="question" class="text-xl text-gray-800 mb-4 min-h-[100px] flex items-center justify-center text-center">
                    {{ card.question }}
                </div>

                <div id="answer" class="text-lg text-gray-700 mb-4 min-h-[100px] flex items-center justify-center text-center hidden">
                    {{ card.answer }}
                </div>
            </div>

            <!-- Action buttons: Show Answer, Review buttons -->
            <div id="card-controls" class="flex flex-col space-y-4">
                <button id="show-answer-btn" class="w-full bg-[#9daca2] text-white py-3 rounded-md hover:bg-opacity-90 transition-colors">
                    Show Answer
                </button>

                <div id="review-buttons" class="hidden grid grid-cols-4 gap-4">
                    <button class="review-btn bg-[#d9b3b3] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="again">
                        Again<br><span class="text-sm text-gray-600">(0 days)</span>
                    </button>
                    <button class="review-btn bg-[#e0c2a2] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="hard">
                        Hard<br><span class="text-sm text-gray-600">(1 day)</span>
                    </button>
                    <button class="review-btn bg-[#b3d9b3] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="good">
                        Good<br><span class="text-sm text-gray-600">(3 days)</span>
                    </button>
                    <button class="review-btn bg-[#b3c6d9] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="easy">
                        Easy<br><span class="text-sm text-gray-600">(5 days)</span>
                    </button>
                </div>             
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const answerDiv = document.getElementById('answer');
        const reviewButtons = document.getElementById('review-buttons');
        const questionDiv = document.getElementById('question');
        const cardsRemaining = document.getElementById('cards-remaining');

        // Get the deck_id from the template
        const deckId = "{{ deck_id }}";
        let currentCardId = "{{ card.id }}";  // Track the current card ID

        // Show the answer when the "Show Answer" button is clicked
        showAnswerBtn.addEventListener('click', function() {
            answerDiv.classList.remove('hidden');
            questionDiv.classList.add('hidden');
            reviewButtons.classList.remove('hidden');
            showAnswerBtn.classList.add('hidden');
        });

        // Handle the review buttons
        const reviewBtns = document.querySelectorAll('.review-btn');
        reviewBtns.forEach(button => {
            button.addEventListener('click', function() {
                const result = button.getAttribute('data-result');
                
                // Send the review result to the backend
                fetch("{% url 'review_card' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        card_id: currentCardId,  // Use the tracked card ID
                        deck_id: deckId,
                        result: result
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update the current card ID with the new one
                        currentCardId = data.next_card_id;
                        
                        // Update the UI with the new card
                        questionDiv.textContent = data.question;
                        answerDiv.textContent = data.answer;
                        cardsRemaining.textContent = data.remaining_cards;

                        // Reset the view for the next card
                        answerDiv.classList.add('hidden');
                        questionDiv.classList.remove('hidden');
                        reviewButtons.classList.add('hidden');
                        showAnswerBtn.classList.remove('hidden');
                    } else if (data.status === 'completed') {
                        window.location.href = "{% url 'no_cards_due' %}";
                    } else {
                        alert("Error: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            });
        });
    });
</script>
{% endblock %}