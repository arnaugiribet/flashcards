{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)]">
    <div class="w-full max-w-2xl">
        <div class="bg-[#f4f6f5] rounded-lg shadow-md p-8">
            <div class="text-center mb-6">
                <h2 class="text-[#9daca2] text-2xl font-bold mb-2">Study Mode</h2>
                <p class="text-gray-600">Cards remaining: <span id="cards-remaining">{{ total_due_cards }}</span></p>
            </div>

            <div id="flashcard-container" class="bg-white rounded-lg p-6 shadow-inner mb-6 transition-all duration-300">
                <div id="question" class="text-xl text-gray-800 mb-4 min-h-[100px] flex items-center justify-center text-center">
                    {{ card.question }}
                </div>

                <div id="answer" class="text-lg text-gray-700 mb-4 min-h-[100px] flex items-center justify-center text-center hidden">
                    {{ card.answer }}
                </div>

                <div id="card-controls" class="flex flex-col space-y-4">
                    <button id="show-answer-btn" class="w-full bg-[#9daca2] text-white py-3 rounded-md hover:bg-opacity-90 transition-colors">
                        Show Answer
                    </button>

                    <div id="review-buttons" class="hidden grid grid-cols-4 gap-4">
                        <button class="review-btn bg-[#d9b3b3] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="again">
                            Again<br><span class="text-sm text-gray-600">(0 days)</span>
                        </button>
                        <button class="review-btn bg-[#e0c2a2] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="hard">
                            Hard<br><span class="text-sm text-gray-600">(1 day)</span>
                        </button>
                        <button class="review-btn bg-[#b3d9b3] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="good">
                            Good<br><span class="text-sm text-gray-600">(3 days)</span>
                        </button>
                        <button class="review-btn bg-[#b3c6d9] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="easy">
                            Easy<br><span class="text-sm text-gray-600">(5 days)</span>
                        </button>
                    </div>                
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const cards = [];
        let dueCards = [];
        let currentCardIndex = 0;

        const fetchAllCardsUrl = "{% url 'get_all_cards' %}";
        const reviewCardUrl = "{% url 'review_card' %}";
        const csrfToken = "{{ csrf_token }}";

        const flashcardContainer = document.getElementById('flashcard-container');
        const questionDiv = document.getElementById('question');
        const answerDiv = document.getElementById('answer');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const reviewButtons = document.getElementById('review-buttons');
        const cardsRemainingSpan = document.getElementById('cards-remaining');

        async function fetchAllCards() {
            try {
                const response = await fetch(fetchAllCardsUrl, { method: 'GET' });
                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    return data.cards; // Array of all cards
                } else {
                    throw new Error(data.message || 'Failed to fetch cards');
                }
            } catch (error) {
                console.error('Error fetching cards:', error);
                alert('Unable to load cards. Please refresh the page.');
            }
        }

        function displayCard(card) {
            questionDiv.textContent = card.question;
            answerDiv.textContent = card.answer;
            answerDiv.classList.add('hidden');
            showAnswerBtn.classList.remove('hidden');
            reviewButtons.classList.add('hidden');
        }

        async function updateCard(cardId, result) {
            // Update the server asynchronously without waiting for the response
            fetch(reviewCardUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ card_id: cardId, result: result }),
            }).catch(error => {
                console.error('Error updating card:', error);
            });
        }

        function moveToNextCard() {
            currentCardIndex++;

            if (currentCardIndex < dueCards.length) {
                displayCard(dueCards[currentCardIndex]);
                cardsRemainingSpan.textContent = dueCards.length - currentCardIndex;
            } else {
                flashcardContainer.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-[#9daca2] text-2xl mb-4">Congratulations!</h3>
                        <p class="text-gray-600 mb-6">You've completed all your due cards for today.</p>
                        <div class="flex justify-center space-x-4">
                            <a href="{% url 'home' %}" class="bg-[#9daca2] text-white px-4 py-2 rounded-md hover:bg-opacity-90">
                                Back to Home
                            </a>
                            <a href="{% url 'add_flashcards' %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                                Add More Cards
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize the app
        const allCards = await fetchAllCards();
        dueCards = allCards.filter(card => card.is_due);  // Filter due cards only
        if (dueCards.length > 0) {
            displayCard(dueCards[currentCardIndex]);
            cardsRemainingSpan.textContent = dueCards.length;
        } else {
            flashcardContainer.innerHTML = `
                <div class="text-center">
                    <h3 class="text-[#9daca2] text-2xl mb-4">No cards to review</h3>
                    <p class="text-gray-600">You have completed all due cards!</p>
                    <a href="{% url 'home' %}" class="bg-[#9daca2] text-white px-4 py-2 rounded-md hover:bg-opacity-90">
                        Back to Home
                    </a>
                </div>
            `;
        }

        // Event listeners
        showAnswerBtn.addEventListener('click', function () {
            answerDiv.classList.remove('hidden');
            showAnswerBtn.classList.add('hidden');
            reviewButtons.classList.remove('hidden');
        });

        document.querySelectorAll('.review-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const result = this.getAttribute('data-result');
                const currentCard = dueCards[currentCardIndex];
                updateCard(currentCard.id, result);
                moveToNextCard();
            });
        });
    });

</script>
{% endblock %}