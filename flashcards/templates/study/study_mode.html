{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)]">
    <div class="w-full max-w-2xl">
        <div class="bg-[#f4f6f5] rounded-lg shadow-md p-8">
            <div class="text-center mb-6">
                <h2 class="text-[#9daca2] text-2xl font-bold mb-2">Study Mode</h2>
                <p class="text-gray-600">Cards remaining: <span id="cards-remaining">{{ total_due_cards }}</span></p>
            </div>

            <div id="flashcard-container" class="bg-white rounded-lg p-6 shadow-inner mb-6 transition-all duration-300">
                <div id="question" class="text-xl text-gray-800 mb-4 min-h-[100px] flex items-center justify-center text-center">
                    {{ card.question }}
                </div>

                <div id="answer" class="text-lg text-gray-700 mb-4 min-h-[100px] flex items-center justify-center text-center hidden">
                    {{ card.answer }}
                </div>

                <div id="card-controls" class="flex flex-col space-y-4">
                    <button id="show-answer-btn" class="w-full bg-[#9daca2] text-white py-3 rounded-md hover:bg-opacity-90 transition-colors">
                        Show Answer
                    </button>

                    <div id="review-buttons" class="hidden grid grid-cols-4 gap-4">
                        <button class="review-btn bg-[#d9b3b3] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="again">
                            Again
                        </button>
                        <button class="review-btn bg-[#e0c2a2] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="hard">
                            Hard
                        </button>
                        <button class="review-btn bg-[#b3d9b3] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="good">
                            Good
                        </button>
                        <button class="review-btn bg-[#b3c6d9] text-gray-700 py-3 rounded-md hover:opacity-90 transition-colors" data-result="easy">
                            Easy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const answerDiv = document.getElementById('answer');
        const reviewButtons = document.getElementById('review-buttons');
        const questionDiv = document.getElementById('question');
        const cardsRemainingSpan = document.getElementById('cards-remaining');
        const flashcardContainer = document.getElementById('flashcard-container');

        // CSRF token and URL for review
        const reviewCardUrl = "{% url 'review_card' %}";
        const csrfToken = "{{ csrf_token }}";
        const cardId = "{{ card.id }}";

        // Disable buttons during fetch to prevent multiple submissions
        function setButtonsState(disabled) {
            document.querySelectorAll('.review-btn, #show-answer-btn').forEach(btn => {
                btn.disabled = disabled;
                btn.classList.toggle('opacity-50', disabled);
            });
        }

        showAnswerBtn.addEventListener('click', function() {
            answerDiv.classList.remove('hidden');
            showAnswerBtn.classList.add('hidden');
            reviewButtons.classList.remove('hidden');
        });
        
        // Centralized error handling
        function handleError(error) {
            console.error('Review error:', error);
            setButtonsState(false);
            flashcardContainer.classList.remove('opacity-50');
            alert(`An error occurred: ${error.message || 'Unknown error'}`);
        }

        // Fetch next card
        async function fetchNextCard(cardId, result) {
            setButtonsState(true);
            flashcardContainer.classList.add('opacity-50');

            try {
                const response = await fetch(reviewCardUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        card_id: cardId,
                        result: result
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch next card');
                }

                return data;
            } catch (error) {
                handleError(error);
                throw error;
            }
        }

        // Update card UI
        function updateCardUI(data) {
            setButtonsState(false);
            flashcardContainer.classList.remove('opacity-50');

            if (data.status === 'success') {
                // Update card content
                questionDiv.textContent = data.question;
                answerDiv.textContent = data.answer;
                
                // Update remaining cards count
                cardsRemainingSpan.textContent = data.remaining_cards;
                
                // Reset UI
                answerDiv.classList.add('hidden');
                showAnswerBtn.classList.remove('hidden');
                reviewButtons.classList.add('hidden');
            } else if (data.status === 'completed') {
                // All cards reviewed
                flashcardContainer.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-[#9daca2] text-2xl mb-4">Congratulations!</h3>
                        <p class="text-gray-600 mb-6">You've completed all your due cards for today.</p>
                        <div class="flex justify-center space-x-4">
                            <a href="{% url 'home' %}" class="bg-[#9daca2] text-white px-4 py-2 rounded-md hover:bg-opacity-90">
                                Back to Home
                            </a>
                            <a href="{% url 'add_flashcards' %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                                Add More Cards
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        // Review button event listeners
        document.querySelectorAll('.review-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const result = this.getAttribute('data-result');

                try {
                    const data = await fetchNextCard(cardId, result);
                    updateCardUI(data);
                } catch (error) {
                    // Error already handled in fetchNextCard
                }
            });
        });
    });
</script>
{% endblock %}