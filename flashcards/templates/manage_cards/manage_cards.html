{% extends "base.html" %}

{% block content %}
<div class="container mx-auto mt-8">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <h1 class="text-2xl font-bold mb-4">Manage Your Flashcards</h1>

    <!-- Table to Display Flashcards -->
    <div class="overflow-x-auto">
        <table class="table-auto w-full border-collapse border border-gray-300">
            <thead class="bg-gray-200">
                <tr>
                    <th class="border border-gray-300 px-4 py-2">
                        <a href="?sort_by=question" class="hover:text-blue-600">Card Question</a>
                    </th>
                    <th class="border border-gray-300 px-4 py-2">
                        <a href="?sort_by=answer" class="hover:text-blue-600">Card Answer</a>
                    </th>
                    <th class="border border-gray-300 px-4 py-2">
                        <a href="?sort_by=deck" class="hover:text-blue-600">Deck</a>
                    </th>
                    <th class="border border-gray-300 px-4 py-2">
                        <a href="?sort_by=due" class="hover:text-blue-600">Due Date</a>
                    </th>
                    <th class="border border-gray-300 px-4 py-2">
                        <a href="?sort_by=creation_date" class="hover:text-blue-600">Creation Date</a>
                    </th>
                    <th class="border border-gray-300 px-4 py-2">Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for card in cards %}
                <tr class="hover:bg-gray-100">
                    <!-- Editable Question Column -->
                    <td class="border border-gray-300 px-4 py-2">
                        <input type="text" value="{{ card.question }}" class="edit-field w-full" data-card-id="{{ card.id }}" data-field="question">
                    </td>
                    
                    <!-- Editable Answer Column -->
                    <td class="border border-gray-300 px-4 py-2">
                        <input type="text" value="{{ card.answer }}" class="edit-field w-full" data-card-id="{{ card.id }}" data-field="answer">
                    </td>
                    
                    <!-- Editable Deck Column -->
                    <td class="border border-gray-300 px-4 py-2">
                        <select class="edit-deck w-full" data-card-id="{{ card.id }}" data-field="deck">
                            {% for deck in decks %}
                                <option value="{{ deck.id }}" {% if card.deck.id == deck.id %}selected{% endif %}>
                                    {{ deck.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    
                    <td class="border border-gray-300 px-4 py-2">{{ card.due }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ card.creation_date }}</td>
                    <td class="border border-gray-300 px-4 py-2 text-center">
                        <!-- Delete Button -->
                        <button onclick="deleteCard('{{ card.id }}')" class="text-red-600 hover:text-red-800 py-1 px-3 rounded bg-gray-200 hover:bg-gray-300">
                            Delete
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center border border-gray-300 px-4 py-2">No flashcards found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get all editable input fields (Question, Answer, Deck)
        const editFields = document.querySelectorAll('.edit-field');
        const editDecks = document.querySelectorAll('.edit-deck');
        
        // Add event listener for input field changes (Question and Answer)
        editFields.forEach(field => {
            field.addEventListener('blur', function() {
                const cardId = this.getAttribute('data-card-id');
                const fieldName = this.getAttribute('data-field');
                const fieldValue = this.value;

                // Send the updated field value to the server
                updateCardField(cardId, fieldName, fieldValue);
            });
        });

        // Add event listener for deck dropdown change
        editDecks.forEach(field => {
            field.addEventListener('change', function() {
                const cardId = this.getAttribute('data-card-id');
                const fieldName = this.getAttribute('data-field');
                const fieldValue = this.value;

                // Send the updated field value to the server
                updateCardField(cardId, fieldName, fieldValue);
            });
        });

        // Function to update the card field via AJAX
        function updateCardField(cardId, fieldName, fieldValue) {
            const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

            fetch(`/update_card_field/${cardId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    field: fieldName,
                    value: fieldValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Card updated successfully');
                } else {
                    console.error('Failed to update card:', data.message);
                }
            })
            .catch(err => console.error('Error updating card:', err));
        }

    });

    // Function to delete a card
    function deleteCard(cardId) {
        const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

        fetch(`/delete_card/${cardId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload the page to update the list
            } else {
                console.error('Delete failed:', data.message);
            }
        })
        .catch(err => console.error('Error deleting card:', err));
    }
</script>
{% endblock %}
