{% extends "base.html" %}

{% block content %}
<div class="container mx-auto mt-8">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <h1 class="text-2xl font-bold mb-8 text-[#9daca2]">Manage Your Flashcards</h1>

    <div class="overflow-x-auto">
        <table class="table-auto w-full">
            <thead class="bg-[#a2b8d0] text-white">
                <tr>
                    <th class="px-4 py-2 text-left" style="width: 30%;">
                        <a href="?sort_by=question" class="hover:text-[#7f8c8d]">Card Question</a>
                    </th>
                    <th class="px-4 py-2 text-left" style="width: 30%;">
                        <a href="?sort_by=answer" class="hover:text-[#7f8c8d]">Card Answer</a>
                    </th>
                    <th class="px-4 py-2 text-left" style="width: 12%;">
                        <a href="?sort_by=deck" class="hover:text-[#7f8c8d]">Deck</a>
                    </th>
                    <th class="px-4 py-2 text-left" style="width: 13%;">
                        <a href="?sort_by=due" class="hover:text-[#7f8c8d]">Due Date</a>
                    </th>
                    <th class="px-4 py-2 text-left" style="width: 13%;">
                        <a href="?sort_by=creation_date" class="hover:text-[#7f8c8d]">Creation Date</a>
                    </th>
                    <th class="px-4 py-2" style="width: 2%;"></th>
                </tr>                
            </thead>
            <tbody>
                {% for card in cards %}
                <tr class="bg-[#f4f6f5] hover:bg-gray-100">
                    <td class="px-4 py-2">
                        <textarea class="edit-field w-full" data-card-id="{{ card.id }}" data-field="question">{{ card.question }}</textarea>
                    </td>
                    <td class="px-4 py-2">
                        <textarea class="edit-field w-full" data-card-id="{{ card.id }}" data-field="answer">{{ card.answer }}</textarea>
                    </td>
                    
                    <td class="px-4 py-2">
                        {{ card.deck.name }}
                    </td>
                    <td class="px-4 py-2">{{ card.due }}</td>
                    <td class="px-4 py-2">{{ card.creation_date }}</td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="promptDelete('{{ card.id }}')" class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center px-4 py-2">No flashcards found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Confirm discard flashcard modal -->
<div id="confirm-discard-flashcard" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg text-center max-w-sm w-full">
        <p class="mb-4 text-sm text-gray-800">Are you sure you want to delete this card?</p>
        <div class="flex justify-center gap-3">
            <button id="confirm-yes" class="text-sm bg-red-50 border border-red-300 rounded-md px-4 py-1.5 text-red-600 hover:bg-red-100 transition-colors">
                Yes
            </button>
            <button id="confirm-no" class="text-sm bg-gray-50 border border-gray-300 rounded-md px-4 py-1.5 text-gray-700 hover:bg-gray-100 transition-colors">
                Cancel
            </button>
        </div>
    </div>
</div>

<style>
    .options-modal {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 10;
        width: max-content;
    }

    .options-modal.hidden {
        display: none;
    }

    .options-modal.show {
        display: block;
    }
</style>


<script>
    // Initialize var cardToDelete to delete after confirmation
    let cardToDelete = null;

    // Show confirmation modal to delete card
    function promptDelete(cardId) {
        cardToDelete = cardId;
        document.getElementById('confirm-discard-flashcard').classList.remove('hidden');
    }

    // Get confirmation to delete card
    document.getElementById('confirm-yes').addEventListener('click', function () {
        if (cardToDelete) {
            deleteCard(cardToDelete);
            cardToDelete = null;
            document.getElementById('confirm-discard-flashcard').classList.add('hidden');
        }
    });

    // Cancel to delete card
    document.getElementById('confirm-no').addEventListener('click', function () {
        cardToDelete = null;
        document.getElementById('confirm-discard-flashcard').classList.add('hidden');
    });

    // Function to delete a card
    function deleteCard(cardId) {
        const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

        fetch(`/delete_card/${cardId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload the page to update the list
            } else {
                console.error('Delete failed:', data.message);
            }
        })
        .catch(err => console.error('Error deleting card:', err));
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Get all editable input fields (Question, Answer, Deck)
        const editFields = document.querySelectorAll('.edit-field');
        const editDecks = document.querySelectorAll('.edit-deck');
        
        // Add event listener for input field changes (Question and Answer)
        editFields.forEach(field => {
            field.addEventListener('blur', function() {
                const cardId = this.getAttribute('data-card-id');
                const fieldName = this.getAttribute('data-field');
                const fieldValue = this.value;

                // Send the updated field value to the server
                updateCardField(cardId, fieldName, fieldValue);
            });
        });

        // Add event listener for deck dropdown change
        editDecks.forEach(field => {
            field.addEventListener('change', function() {
                const cardId = this.getAttribute('data-card-id');
                const fieldName = this.getAttribute('data-field');
                const fieldValue = this.value;

                // Send the updated field value to the server
                updateCardField(cardId, fieldName, fieldValue);
            });
        });

        // Function to update the card field via AJAX
        function updateCardField(cardId, fieldName, fieldValue) {
            const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

            fetch(`/update_card_field/${cardId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    field: fieldName,
                    value: fieldValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Card updated successfully');
                } else {
                    console.error('Failed to update card:', data.message);
                }
            })
            .catch(err => console.error('Error updating card:', err));
        }

    });


    // Open the modal at the position of the clicked button
    function openMenu(cardId, button) {
        // Find all modals
        const modals = document.querySelectorAll('.options-modal');
    
        // Close all other modals
        modals.forEach(modal => {
            if (!modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                modal.classList.remove('show');
            }
        });

        // Get clicked
        const modal = document.getElementById(`optionsModal_${cardId}`);
        
        // Toggle modal visibility by toggling the 'show' class
        modal.classList.toggle('hidden');
        modal.classList.toggle('show');

        // Position the modal right below the button (three dots)
        const buttonRect = button.getBoundingClientRect();
        modal.style.left = `${buttonRect.right - modal.offsetWidth}px`; // Position it aligned to the right
        modal.style.top = `${buttonRect.top + window.scrollY - modal.offsetHeight - 5}px`; // Position it above the button, with a 5px margin
    }

    // Close the modal when clicking outside of it
    document.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.options-modal');
        modals.forEach(modal => {
            if (!modal.contains(event.target) && !event.target.closest('button[onclick^="openMenu"]')) {
                modal.classList.add('hidden');
                modal.classList.remove('show');
            }
        });
    });

</script>
{% endblock %}
