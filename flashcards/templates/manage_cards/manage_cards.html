{% extends "base.html" %}

{% block content %}
<div class="container mx-auto mt-8">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <h1 class="text-2xl font-bold mb-8 text-[#9daca2]">Manage Your Flashcards</h1>

    <div class="overflow-x-auto">
        <table class="table-auto w-full">
            <thead class="bg-[#a2b8d0] text-white">
                <tr>
                    <th class="px-4 py-2 text-left w-6/20">
                        <a href="?sort_by=question" class="hover:text-[#7f8c8d]">Card Question</a>
                    </th>
                    <th class="px-4 py-2 text-left w-6/20">
                        <a href="?sort_by=answer" class="hover:text-[#7f8c8d]">Card Answer</a>
                    </th>
                    <th class="px-4 py-2 text-left w-3/20 max-w-xs overflow-hidden">
                        <a href="?sort_by=deck" class="hover:text-[#7f8c8d]">Deck</a>
                    </th>
                    <th class="px-4 py-2 text-left w-3/20">
                        <a href="?sort_by=due" class="hover:text-[#7f8c8d]">Due Date</a>
                    </th>
                    <th class="px-4 py-2 text-left w-2/20">
                        <a href="?sort_by=creation_date" class="hover:text-[#7f8c8d]">Creation Date</a>
                    </th>
                    <th class="px-4 py-2 w-12"></th>
                </tr>                
            </thead>
            <tbody>
                {% for card in cards %}
                <tr class="bg-[#f4f6f5] hover:bg-gray-100">
                    <td class="px-4 py-2">
                        <input type="text" value="{{ card.question }}" class="edit-field w-full" data-card-id="{{ card.id }}" data-field="question">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" value="{{ card.answer }}" class="edit-field w-full" data-card-id="{{ card.id }}" data-field="answer">
                    </td>
                    <td class="px-4 py-2">
                        <select class="edit-deck w-full" data-card-id="{{ card.id }}" data-field="deck">
                            {% for deck in decks %}
                                <option value="{{ deck.id }}" {% if card.deck.id == deck.id %}selected{% endif %}>
                                    {{ deck.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="px-4 py-2">{{ card.due }}</td>
                    <td class="px-4 py-2">{{ card.creation_date }}</td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="openMenu('{{ card.id }}', this)" class="text-gray-600 hover:text-gray-800 py-1 px-3 rounded">
                            &#8942;
                        </button>

                        <!-- Modal (hidden by default) -->
                        <div id="optionsModal_{{ card.id }}" class="options-modal hidden absolute bg-white shadow-lg p-4 rounded mt-2 z-10">
                            <button onclick="deleteCard('{{ card.id }}')" class="bg-[#d4a8a8] text-white px-4 py-2 rounded">Delete</button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center px-4 py-2">No flashcards found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .options-modal {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 10;
        width: max-content;
    }

    .options-modal.hidden {
        display: none;
    }

    .options-modal.show {
        display: block;
    }
</style>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get all editable input fields (Question, Answer, Deck)
        const editFields = document.querySelectorAll('.edit-field');
        const editDecks = document.querySelectorAll('.edit-deck');
        
        // Add event listener for input field changes (Question and Answer)
        editFields.forEach(field => {
            field.addEventListener('blur', function() {
                const cardId = this.getAttribute('data-card-id');
                const fieldName = this.getAttribute('data-field');
                const fieldValue = this.value;

                // Send the updated field value to the server
                updateCardField(cardId, fieldName, fieldValue);
            });
        });

        // Add event listener for deck dropdown change
        editDecks.forEach(field => {
            field.addEventListener('change', function() {
                const cardId = this.getAttribute('data-card-id');
                const fieldName = this.getAttribute('data-field');
                const fieldValue = this.value;

                // Send the updated field value to the server
                updateCardField(cardId, fieldName, fieldValue);
            });
        });

        // Function to update the card field via AJAX
        function updateCardField(cardId, fieldName, fieldValue) {
            const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

            fetch(`/update_card_field/${cardId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    field: fieldName,
                    value: fieldValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Card updated successfully');
                } else {
                    console.error('Failed to update card:', data.message);
                }
            })
            .catch(err => console.error('Error updating card:', err));
        }

    });


    // Open the modal at the position of the clicked button
    function openMenu(cardId, button) {
        // Find all modals
        const modals = document.querySelectorAll('.options-modal');
    
        // Close all other modals
        modals.forEach(modal => {
            if (!modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                modal.classList.remove('show');
            }
        });

        // Get clicked
        const modal = document.getElementById(`optionsModal_${cardId}`);
        
        // Toggle modal visibility by toggling the 'show' class
        modal.classList.toggle('hidden');
        modal.classList.toggle('show');

        // Position the modal right below the button (three dots)
        const buttonRect = button.getBoundingClientRect();
        modal.style.left = `${buttonRect.right - modal.offsetWidth}px`; // Position it aligned to the right
        modal.style.top = `${buttonRect.top + window.scrollY - modal.offsetHeight - 5}px`; // Position it above the button, with a 5px margin
    }

    // Close the modal when clicking outside of it
    document.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.options-modal');
        modals.forEach(modal => {
            if (!modal.contains(event.target) && !event.target.closest('button[onclick^="openMenu"]')) {
                modal.classList.add('hidden');
                modal.classList.remove('show');
            }
        });
    });

    // Function to delete a card
    function deleteCard(cardId) {
        const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

        fetch(`/delete_card/${cardId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload the page to update the list
            } else {
                console.error('Delete failed:', data.message);
            }
        })
        .catch(err => console.error('Error deleting card:', err));
    }
</script>
{% endblock %}
