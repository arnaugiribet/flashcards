{% extends "base.html" %}

{% block title %}Create Flashcards - FlashApp{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 2rem auto; padding: 2rem;">
    <div style="background-color: #f4f6f5; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h1 class="text-2xl font-semibold text-center mb-6" style="color: #6b8276;">Create Flashcards Automatically</h1>
        
        <form id="flashcard-form" action="{% url 'process_file_and_context' %}" method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            <!-- Input Type Selection -->
            <div class="flex justify-center gap-6 mb-4">
                <label class="inline-flex items-center">
                    <input type="radio" name="input_type" value="file" checked class="hidden" onchange="toggleInputType()">
                    <span class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer transition-colors"
                          style="background-color: #9daca2; color: white;" 
                          id="file-label">
                        Upload File
                    </span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="input_type" value="text" class="hidden" onchange="toggleInputType()">
                    <span class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer transition-colors"
                          style="background-color: #d8e0dc; color: #6b8276;"
                          id="text-label">
                        Paste Text
                    </span>
                </label>
            </div>

            <!-- File Upload Input -->
            <div id="file-input-section">
                <div class="relative flex items-center">
                    <input type="file" name="file" id="file" accept=".txt,.pdf,.doc,.docx,.ppt,.pptx" class="hidden">
                    <button type="button"
                            onclick="document.getElementById('file').click()" 
                            class="px-4 py-2 rounded-md text-sm font-medium text-white"
                            style="background-color: #9daca2;">
                        Select File
                    </button>
                    <span id="file-name" class="text-sm ml-3" style="color: #666;">
                        No file selected
                    </span>
                </div>
            </div>

            <!-- Text Input -->
            <div id="text-input-section" style="display: none;">
                <textarea name="input_text" 
                          rows="6" 
                          placeholder="Paste your text here..."
                          class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-[#9daca2] focus:border-[#9daca2]"
                          style="width: 100%;"></textarea>
            </div>

            <!-- Context Input (unchanged) -->
            <div>
                <label for="context" class="block text-sm font-medium" style="color: #6b8276;">
                    Provide Context (Optional)
                </label>
                <textarea name="context" 
                          id="context" 
                          rows="3"
                          placeholder="Provide any additional context: language, number of cards..."
                          class="mt-1 block w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-[#9daca2] focus:border-[#9daca2] p-2"
                          style="width: 100%;"></textarea>
            </div>

            <!-- Generate Button -->
            <div class="flex justify-center">
                <button type="submit" 
                        id="generate-button"
                        class="px-4 py-2 rounded-md text-sm font-medium text-white"
                        style="background-color: #9daca2;">
                    Generate Cards
                </button>
            </div>

            <!-- Error message display -->
            <div id="error-message" class="rounded-lg bg-red-50 p-4 text-sm text-red-500 mt-4 hidden flex justify-center items-center">
                <p id="error-text"></p>
            </div>
        </form>
    </div>

     <!-- Flashcards Display Section -->
     <div id="flashcards-container" class="mt-8 hidden">
        <div class="flex flex-col mb-4">
            <h2 class="text-2xl font-semibold text-center" style="color: #6b8276;">Generated Flashcards</h2>
            <!-- Deck Selector -->
            <div 
                class="flex items-center justify-center space-x-2 mt-4"
                id="deck-selector-container"
            >
            <label for="deck-selector" class="text-sm font-medium" style="color: #6b8276;">Select Deck:</label>
            <select 
                id="deck-selector" 
                class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-[#9daca2] focus:border-[#9daca2] p-2"
                required 
            >
                {% for deck in ordered_decks %}
                    <option value="{{ deck.id }}" {% if forloop.first %}selected{% endif %}>
                        {{ deck.name }}
                    </option>
                {% endfor %}
            </select>
            </div>
            <!-- Add All and Discard All buttons -->
            <div class="flex space-x-2 mt-5 justify-center">
                <button 
                    id="add-all-btn"
                    class="px-4 py-2 rounded-md text-sm font-medium text-white flex items-center" 
                    style="background-color: #a2b8d0;"
                >
                    Add All
                </button>
                <button 
                    id="discard-all-btn"
                    class="px-4 py-2 rounded-md text-sm font-medium text-white flex items-center" 
                    style="background-color: #d4a8a8;"
                >
                    Discard All
                </button>
            </div>
        </div>

        <!-- Flashcards Box with Horizontal Scroll -->
        <div id="flashcards-box" class="overflow-x-auto py-4">
            <div id="flashcards-grid" class="flex space-x-4">
                <!-- Flashcards will be inserted here -->
            </div>
        </div>

        <!-- Add a message for when no cards are available -->
        <div id="no-cards-message" class="text-center text-xl text-gray-600 mt-8 hidden">
            No generated cards left to manage.
        </div>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div id="discard-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white rounded-lg p-6 w-96 shadow-lg">
        <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Discard all generated cards?</h2>
        <p class="text-center text-gray-600 mb-6">This will delete all the generated flashcards. This action cannot be undone.</p>
        <div class="flex justify-center gap-4">
            <button id="cancel-discard" class="btn cancel-btn px-4 py-2 bg-gray-300 rounded-md text-sm text-gray-800 hover:bg-gray-400 transition">Cancel</button>
            <button id="confirm-discard" class="btn discard-btn px-4 py-2 text-white rounded-md text-sm hover:bg-[#9daca2] transition">Discard</button>
        </div>
    </div>
</div>



<script>

    // Reference to the generate button
    const generateButton = document.getElementById('generate-button');

    // Initial call to set button state on page load
    updateButtonState();

    // Function to update button state based on input type and content
    function updateButtonState() {
        const isFileSelected = document.querySelector('input[name="input_type"][value="file"]').checked;
        const fileInput = document.getElementById('file');
        const textInput = document.querySelector('textarea[name="input_text"]');

        if (isFileSelected) {
            // Enable if a file is selected
            const hasFile = fileInput.files.length > 0;
            toggleGenerateButton(hasFile);
        } else {
            // Enable if text input has content
            const hasText = textInput.value.trim().length > 0;
            toggleGenerateButton(hasText);
        }
    }

    // Function to toggle generate button
    function toggleGenerateButton(enable) {
        generateButton.disabled = !enable;
        generateButton.style.opacity = enable ? '1' : '0.5';
        generateButton.style.pointerEvents = enable ? 'auto' : 'none';
    }

    // File input change event
    document.getElementById('file').addEventListener('change', function (event) {
        const fileName = event.target.files[0] ? event.target.files[0].name : 'No file selected';
        document.getElementById('file-name').textContent = fileName;
        updateButtonState();
    });

    // Text input change event
    document.querySelector('textarea[name="input_text"]').addEventListener('input', function () {
        updateButtonState();
    });

    // Input type toggle
    function toggleInputType() {
        const fileSection = document.getElementById('file-input-section');
        const textSection = document.getElementById('text-input-section');
        const fileLabel = document.getElementById('file-label');
        const textLabel = document.getElementById('text-label');

        const isFileSelected = document.querySelector('input[name="input_type"][value="file"]').checked;

        fileSection.style.display = isFileSelected ? 'block' : 'none';
        textSection.style.display = isFileSelected ? 'none' : 'block';

        // Update button styles
        fileLabel.style.backgroundColor = isFileSelected ? '#9daca2' : '#d8e0dc';
        fileLabel.style.color = isFileSelected ? 'white' : '#6b8276';
        textLabel.style.backgroundColor = isFileSelected ? '#d8e0dc' : '#9daca2';
        textLabel.style.color = isFileSelected ? '#6b8276' : 'white';

        updateButtonState(); // Ensure button state is updated after toggling input type
    }

    // Shared array to store flashcards
    let flashcards = [];

    // File input handler
    document.getElementById('file').addEventListener('change', function (event) {
        const fileLabel = document.getElementById('file-name');
        const generateButton = document.getElementById('generate-button');
        
        if (event.target.files.length > 0) {
            fileLabel.textContent = event.target.files[0].name;
            generateButton.disabled = false;
            generateButton.style.opacity = '1';
            generateButton.style.pointerEvents = 'auto';
        } else {
            fileLabel.textContent = 'No file selected';
            generateButton.disabled = true;
            generateButton.style.opacity = '0.5';
            generateButton.style.pointerEvents = 'none';
        }
    });

    // Form submission handler
    document.getElementById('flashcard-form').addEventListener('submit', function (e) {
        e.preventDefault();
        
        // Clear any previous error messages before submitting the form
        const errorMessageDiv = document.getElementById('error-message');
        errorMessageDiv.classList.add('hidden');  // Hide the error message div

        let formData = new FormData(this);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const generateButton = document.getElementById('generate-button');
        
        // Disable the button and show loading state
        generateButton.disabled = true;
        generateButton.textContent = 'Generating...';
        generateButton.style.opacity = '0.5';

        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // If successful, update the shared flashcards array and display them
                flashcards = data.flashcards;
                displayFlashcards();
            } else {
                // If the server returns an error, display it in a div (no alert)
                const errorText = data.error || "An unexpected error occurred. Please try again later.";
                document.getElementById('error-text').textContent = errorText;
                document.getElementById('error-message').classList.remove('hidden');
                errorMessageDiv.classList.remove('hidden'); // Make the error div visible
            }
        })
        .catch(error => {
            // If there is a network or other error, show a generic error message
            const errorText = "An unexpected error occurred. Please try again later.";
            document.getElementById('error-text').textContent = errorText;
            document.getElementById('error-message').classList.remove('hidden');
            errorMessageDiv.classList.remove('hidden'); // Make the error div visible
            console.error('Error:', error);
        })
        .finally(() => {
            // Reset button state regardless of success or failure
            generateButton.disabled = false;
            generateButton.textContent = 'Generate Cards';
            generateButton.style.opacity = '1';
        });
    });

    // Function to handle the deletion of a flashcard
    function handleDeleteCard(index) {
        flashcards.splice(index, 1); // Remove the flashcard from the array
        displayFlashcards(); // Refresh the UI
    }

    // Function to handle adding a flashcard to the database
    function handleAddCard(card, index) {
        uploadCardToDatabase(card)
            .then(() => {
                // Get the selected deck name from the deck selector
                const deckSelector = document.getElementById('deck-selector');
                const selectedDeckName = deckSelector.options[deckSelector.selectedIndex].text;

                // Remove the card from the local array after successfully uploading
                flashcards.splice(index, 1);
                displayFlashcards(); // Refresh the UI

                // Show a success notification with the deck name
                showNotification(`Card added to ${selectedDeckName}`, 'success');
            })
            .catch((error) => {
                console.error('Error uploading card:', error);
                alert('Failed to save flashcard: ' + error.message);

                // Show an error notification
                showNotification('Failed to upload flashcard: ' + error.message, 'error');
            });
    }

    // Function to handle adding all the flashcards to the database
    async function handleAddAllCards() {
        try {
            await Promise.all(flashcards.map((card, index) => uploadCardToDatabase(card)));
            flashcards = []; // Clear all cards after success
            displayFlashcards(); // Refresh UI
            // Get the selected deck name from the deck selector
            const deckSelector = document.getElementById('deck-selector');
            const selectedDeckName = deckSelector.options[deckSelector.selectedIndex].text;
            showNotification(`All cards added to ${selectedDeckName}`, 'success');
        } catch (error) {
            console.error('Error uploading cards:', error);
            showNotification('Failed to upload some cards.', 'error');
        }
    }

    // Attach the click event to the Add All button
    document.getElementById('add-all-btn').addEventListener('click', handleAddAllCards);


    function uploadCardToDatabase(card) {
        // Get the selected deck ID from the deck selector
        const deckId = document.getElementById('deck-selector').value;
        
        // Get the CSRF token from the form
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Create form data for the request
        const formData = new FormData();
        formData.append('deck_id', deckId);
        formData.append('question', card.question);
        formData.append('answer', card.answer);

        // Return a promise that resolves when the card is uploaded
        return fetch('/add_flashcards/automatic/', {  
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || '01. Failed to save flashcard');
                });
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || '02. Failed to save flashcard');
            }
            console.log('Card uploaded successfully:', card);
            return data;
        });
    }

    function showNotification(message, type = 'success') {
        const container = document.getElementById('flashcards-container');

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        container.appendChild(notification);

        // Listen for the `animationend` event to remove the element
        notification.addEventListener('animationend', () => {
            container.removeChild(notification);
        });
    }

    // Function to display the flashcards
    function displayFlashcards() {
        console.log('Flashcards in array:', flashcards);
        const container = document.getElementById('flashcards-container');
        const grid = document.getElementById('flashcards-grid');
        const deckSelector = document.getElementById('deck-selector-container');
        const addAllBtn = document.getElementById('add-all-btn');
        const discardAllBtn = document.getElementById('discard-all-btn');
        const noCardsMessage = document.getElementById('no-cards-message') || document.createElement('div');
        const flashcardsBox = document.getElementById('flashcards-box');
        const actionButtons = document.querySelector('.flex.space-x-2.mt-5.justify-center');

        // Create the "no cards" message if it doesn't exist
        if (!noCardsMessage.id) {
            noCardsMessage.id = 'no-cards-message';
            noCardsMessage.className = 'text-center mt-4 text-gray-600';
            noCardsMessage.style.display = 'none';
            noCardsMessage.textContent = 'No generated cards left to manage.';
            container.appendChild(noCardsMessage);
        }

        // Clear the grid before displaying updated cards
        grid.innerHTML = '';

        if (flashcards.length > 0) {
            // Show the flashcards box and action buttons
            flashcardsBox.style.display = 'block';
            deckSelector.style.display = 'flex';
            actionButtons.style.display = 'flex';

            // Hide the cards message
            noCardsMessage.style.display = 'none';

            // Show the action buttons
            addAllBtn.style.display = 'block';
            discardAllBtn.style.display = 'block';

            flashcards.forEach((card, index) => {
                const flashcardElement = document.createElement('div');
                flashcardElement.className = 'flashcard';
                flashcardElement.innerHTML = `
                    <div class="card-header">
                        <span class="card-label">Question</span>
                        <div class="card-controls">
                            <button class="control-btn add-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="control-btn delete-btn">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-content question">${card.question}</div>
                    <div class="card-label answer-label">Answer</div>
                    <div class="card-content answer">${card.answer}</div>
                `;

                // Attach event listeners for add and delete buttons
                const deleteButton = flashcardElement.querySelector('.delete-btn');
                deleteButton.addEventListener('click', () => handleDeleteCard(index));

                const addButton = flashcardElement.querySelector('.add-btn');
                addButton.addEventListener('click', () => handleAddCard(card, index));

                grid.appendChild(flashcardElement);
            });
        } else {
            showNoCardsMessage();
        }

        // Show the container
        container.classList.remove('hidden');
    }

    // Function to show the "No cards" message when all cards are deleted
    function showNoCardsMessage() {
        const flashcardsBox = document.getElementById('flashcards-box');
        const noCardsMessage = document.getElementById('no-cards-message');
        const actionButtons = document.querySelector('.flex.space-x-2.mt-5.justify-center'); // Add All, Discard All buttons
        const deckSelector = document.getElementById('deck-selector-container');
        
        // Hide the flashcard list and action buttons
        flashcardsBox.style.display = 'none';
        actionButtons.style.display = 'none';
        deckSelector.style.display = 'none';

        // Show the "No cards" message
        noCardsMessage.style.display = 'block';
    }

    // Detect deck-selector changes
    document.getElementById('deck-selector').addEventListener('change', function() {
        const selectedDeckId = this.value;
        console.log('Selected Deck ID:', selectedDeckId);
    });

    // Discard All button handler
    document.getElementById('discard-all-btn').addEventListener('click', function () {
        // Show the confirmation modal
        document.getElementById('discard-modal').classList.remove('hidden');
    });

    // Cancel button (Close the modal)
    document.getElementById('cancel-discard').addEventListener('click', function() {
        document.getElementById('discard-modal').classList.add('hidden');
    });

    // Confirm button (Delete all flashcards)
    document.getElementById('confirm-discard').addEventListener('click', function() {
        // Clear the flashcards array
        flashcards = [];
        
        // Update the display
        displayFlashcards();

        // Close the modal
        document.getElementById('discard-modal').classList.add('hidden');
    });

    

</script>

<style>

    #flashcards-container {
        background-color: #f4f6f5; /* Similar background color */
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
    }

    /* Reset container margins and ensure proper width */
    #flashcards-box {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: hidden; /* Prevent horizontal scroll */
        margin: 0;
        padding: 1rem;
        width: 100%;
        box-sizing: border-box;
        padding-right: 1.5rem;
    }

    /* Grid container with proper spacing */
    #flashcards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        width: 100%;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    /* Individual flashcard styling */
    .flashcard {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 1rem;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        margin: 0; /* Remove any margin */
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        width: 100%;
    }

    .card-label {
        color: #6b8276;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .answer-label {
        color: #6b8276;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }

    .card-content {
        color: #4a5568;
        padding: 0.5rem;
        background-color: #f8f9f8;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        word-wrap: break-word;
        width: 100%;
        box-sizing: border-box;
    }

    .card-content.question {
        border-left: 3px solid #9daca2;
    }

    .card-content.answer {
        border-left: 3px solid #6b8276;
    }

    .card-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
    }

    .control-btn {
        background-color: #9daca2;
        border: none;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s;
    }

    .control-btn:hover {
        background-color: #6b8276;
        cursor: pointer;
    }

    .add-btn {
        background-color: #a2b8d0;
    }

    .delete-btn {
        background-color: #d4a8a8;
    }

    #discard-modal {
        transition: opacity 0.3s ease;
    }

    /* Modal buttons */
    #discard-modal button {
        transition: background-color 0.3s ease;
        cursor: pointer;
        transform: scale(1.05);
    }

    /* Hover effect for Cancel button */
    #discard-modal .bg-gray-300 {
        background-color: #f4f6f5; /* Similar to the light background of the app */
        color: #666;
    }

    /* Hover color for Cancel */
    #discard-modal button:hover {
        background-color: #e1e5e1;
    }

    /* Discard Button with Green Hover */
    #discard-modal .discard-btn {
        background-color: #d4a8a8;
    }

    #discard-modal .discard-btn:hover {
        background-color: #9daca2; /* Green hover color */
    }

    .notification {
        position: fixed; /* Keep fixed positioning if needed */
        top: 10px;
        left: 20%;
        transform: translateX(-50%);
        z-index: 1000;
        background-color: #a2b8d0; /* Light blue for success */
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        animation: fade-in-out 2s ease-in-out;
        text-align: center;
        max-width: 80%;
        display: flex; /* Align for potential multiple elements */
        flex-direction: column;
        gap: 10px;
        align-items: center;
    }


    .notification.error {
        background-color: #d4a8a8; /* Light red for error */
    }

    @keyframes fade-in-out {
        0%, 90% {
            opacity: 1;
        }
        100% {
            opacity: 0;
        }
    }


</style>
{% endblock %}
