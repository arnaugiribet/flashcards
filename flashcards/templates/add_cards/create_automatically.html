{% extends "base.html" %}

{% block title %}Create Flashcards - FlashApp{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 2rem auto; padding: 2rem;">
    <div style="background-color: #f4f6f5; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h1 class="text-2xl font-semibold text-center mb-6" style="color: #6b8276;">Create Flashcards Automatically</h1>

        <form id="flashcard-form" action="{% url 'process_file_and_context' %}" method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <div>
                <div class="relative flex items-center">
                    <input 
                        type="file" 
                        name="file" 
                        id="file" 
                        accept=".txt,.pdf,.doc,.docx,.ppt,.pptx" 
                        required
                        class="hidden"
                    >
                    <button 
                        type="button"
                        onclick="document.getElementById('file').click()" 
                        class="px-4 py-2 rounded-md text-sm font-medium text-white"
                        style="background-color: #9daca2; width: fit-content;"
                    >
                        Upload a File
                    </button>
                    <span id="file-label" class="text-sm ml-3" style="color: #666;">
                        No file selected
                    </span>
                </div>
            </div>

            <div>
                <label for="context" class="block text-sm font-medium" style="color: #6b8276;">Provide Context (Optional)</label>
                <textarea 
                    name="context" 
                    id="context" 
                    rows="3"
                    placeholder="Provide any additional context for your flashcards..."
                    class="mt-1 block w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-[#9daca2] focus:border-[#9daca2] p-2"
                ></textarea>
            </div>

            <div class="flex justify-center">
                <button 
                    type="submit" 
                    id="generate-button"
                    disabled
                    class="px-4 py-2 rounded-md text-sm font-medium text-white"
                    style="background-color: #9daca2; opacity: 0.5; pointer-events: none;"
                >
                    Generate Cards
                </button>
            </div>
        </form>
    </div>

     <!-- Flashcards Display Section -->
     <div id="flashcards-container" class="mt-8 hidden">
        <div class="flex flex-col mb-4">
            <h2 class="text-2xl font-semibold text-center" style="color: #6b8276;">Generated Flashcards</h2>
            <!-- Deck Selector -->
            <div 
                class="flex items-center justify-center space-x-2 mt-4"
                id="deck-selector-container"
            >
            <label for="deck-selector" class="text-sm font-medium" style="color: #6b8276;">Select Deck:</label>
            <select 
                id="deck-selector" 
                class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-[#9daca2] focus:border-[#9daca2] p-2"
                required 
            >
                {% for deck in ordered_decks %}
                    <option value="{{ deck.id }}" {% if forloop.first %}selected{% endif %}>
                        {{ deck.name }}
                    </option>
                {% endfor %}
            </select>
            </div>
            <!-- Add All and Discard All buttons -->
            <div class="flex space-x-2 mt-5 justify-center">
                <button 
                    id="add-all-btn"
                    class="px-4 py-2 rounded-md text-sm font-medium text-white flex items-center" 
                    style="background-color: #a2b8d0;"
                >
                    Add All
                </button>
                <button 
                    id="discard-all-btn"
                    class="px-4 py-2 rounded-md text-sm font-medium text-white flex items-center" 
                    style="background-color: #d4a8a8;"
                >
                    Discard All
                </button>
            </div>
        </div>

        <!-- Flashcards Box with Horizontal Scroll -->
        <div id="flashcards-box" class="overflow-x-auto py-4">
            <div id="flashcards-grid" class="flex space-x-4">
                <!-- Flashcards will be inserted here -->
            </div>
        </div>

        <!-- Add a message for when no cards are available -->
        <div id="no-cards-message" class="text-center text-xl text-gray-600 mt-8 hidden">
            No generated cards left to manage.
        </div>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div id="discard-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white rounded-lg p-6 w-96 shadow-lg">
        <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Discard all generated cards?</h2>
        <p class="text-center text-gray-600 mb-6">This will delete all the generated flashcards. This action cannot be undone.</p>
        <div class="flex justify-center gap-4">
            <button id="cancel-discard" class="btn cancel-btn px-4 py-2 bg-gray-300 rounded-md text-sm text-gray-800 hover:bg-gray-400 transition">Cancel</button>
            <button id="confirm-discard" class="btn discard-btn px-4 py-2 text-white rounded-md text-sm hover:bg-[#9daca2] transition">Discard</button>
        </div>
    </div>
</div>



<script>

    // Shared array to store flashcards
    let flashcards = [];

    // File input handler
    document.getElementById('file').addEventListener('change', function (event) {
        const fileLabel = document.getElementById('file-label');
        const generateButton = document.getElementById('generate-button');
        
        if (event.target.files.length > 0) {
            fileLabel.textContent = event.target.files[0].name;
            generateButton.disabled = false;
            generateButton.style.opacity = '1';
            generateButton.style.pointerEvents = 'auto';
        } else {
            fileLabel.textContent = 'No file selected';
            generateButton.disabled = true;
            generateButton.style.opacity = '0.5';
            generateButton.style.pointerEvents = 'none';
        }
    });

    // Form submission handler
    document.getElementById('flashcard-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const generateButton = document.getElementById('generate-button');
        
        // Disable the button and show loading state
        generateButton.disabled = true;
        generateButton.textContent = 'Generating...';
        generateButton.style.opacity = '0.5';

        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the shared flashcards array
                flashcards = data.flashcards;
                
                // Display the updated flashcards
                displayFlashcards();
            } else {
                alert(data.error || 'An error occurred while generating flashcards.');
            }
        })
        .catch(error => {
            alert('An error occurred while generating flashcards.');
            console.error('Error:', error);
        })
        .finally(() => {
            // Reset button state
            generateButton.disabled = false;
            generateButton.textContent = 'Generate Cards';
            generateButton.style.opacity = '1';
        });
    });

    // Function to handle the deletion of a flashcard
    function handleDeleteCard(index) {
        flashcards.splice(index, 1); // Remove the flashcard from the array
        displayFlashcards(); // Refresh the UI
    }

    // Function to handle adding a flashcard to the database
    function handleAddCard(card, index) {
        // Logic to upload the card to the database
        // Replace with your actual upload logic here, e.g. using fetch to POST data
        uploadCardToDatabase(card)
            .then(() => {
                // Remove the card from the local array after successfully uploading
                flashcards.splice(index, 1);
                displayFlashcards(); // Refresh the UI
            })
            .catch((error) => {
                console.error('Error uploading card:', error);
            });
    }

    // Example function for uploading to the database (replace with actual logic)
    function uploadCardToDatabase(card) {
        return new Promise((resolve, reject) => {
            // Simulate an upload with a timeout
            setTimeout(() => {
                console.log('Card uploaded:', card);
                resolve();
            }, 500); // Simulate network delay
        });
    }

    // Function to display the flashcards
    function displayFlashcards() {
        console.log('Flashcards in array:', flashcards);
        const container = document.getElementById('flashcards-container');
        const grid = document.getElementById('flashcards-grid');
        const deckSelector = document.getElementById('deck-selector-container');
        const addAllBtn = document.getElementById('add-all-btn');
        const discardAllBtn = document.getElementById('discard-all-btn');
        const noCardsMessage = document.getElementById('no-cards-message') || document.createElement('div');
        const flashcardsBox = document.getElementById('flashcards-box');
        const actionButtons = document.querySelector('.flex.space-x-2.mt-5.justify-center');

        // Create the "no cards" message if it doesn't exist
        if (!noCardsMessage.id) {
            noCardsMessage.id = 'no-cards-message';
            noCardsMessage.className = 'text-center mt-4 text-gray-600';
            noCardsMessage.style.display = 'none';
            noCardsMessage.textContent = 'No generated cards left to manage.';
            container.appendChild(noCardsMessage);
        }

        // Clear the grid before displaying updated cards
        grid.innerHTML = '';

        if (flashcards.length > 0) {
            // Show the flashcards box and action buttons
            flashcardsBox.style.display = 'block';
            deckSelector.style.display = 'flex';
            actionButtons.style.display = 'flex';

            // Hide the cards message
            noCardsMessage.style.display = 'none';

            // Show the action buttons
            addAllBtn.style.display = 'block';
            discardAllBtn.style.display = 'block';

            flashcards.forEach((card, index) => {
                const flashcardElement = document.createElement('div');
                flashcardElement.className = 'flashcard';
                flashcardElement.innerHTML = `
                    <div class="card-header">
                        <span class="card-label">Question</span>
                        <div class="card-controls">
                            <button class="control-btn add-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="control-btn delete-btn">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-content question">${card.question}</div>
                    <div class="card-label answer-label">Answer</div>
                    <div class="card-content answer">${card.answer}</div>
                `;

                // Attach event listeners for add and delete buttons
                const deleteButton = flashcardElement.querySelector('.delete-btn');
                deleteButton.addEventListener('click', () => handleDeleteCard(index));

                const addButton = flashcardElement.querySelector('.add-btn');
                addButton.addEventListener('click', () => handleAddCard(card, index));

                grid.appendChild(flashcardElement);
            });
        } else {
            showNoCardsMessage();
        }

        // Show the container
        container.classList.remove('hidden');
    }

    // Function to show the "No cards" message when all cards are deleted
    function showNoCardsMessage() {
        const flashcardsBox = document.getElementById('flashcards-box');
        const noCardsMessage = document.getElementById('no-cards-message');
        const actionButtons = document.querySelector('.flex.space-x-2.mt-5.justify-center'); // Add All, Discard All buttons
        const deckSelector = document.getElementById('deck-selector-container');
        
        // Hide the flashcard list and action buttons
        flashcardsBox.style.display = 'none';
        actionButtons.style.display = 'none';
        deckSelector.style.display = 'none';

        // Show the "No cards" message
        noCardsMessage.style.display = 'block';
    }

    // Detect deck-selector changes
    document.getElementById('deck-selector').addEventListener('change', function() {
        const selectedDeckId = this.value;
        console.log('Selected Deck ID:', selectedDeckId);
    });

    // Discard All button handler
    document.getElementById('discard-all-btn').addEventListener('click', function () {
        // Show the confirmation modal
        document.getElementById('discard-modal').classList.remove('hidden');
    });

    // Cancel button (Close the modal)
    document.getElementById('cancel-discard').addEventListener('click', function() {
        document.getElementById('discard-modal').classList.add('hidden');
    });

    // Confirm button (Delete all flashcards)
    document.getElementById('confirm-discard').addEventListener('click', function() {
        // Clear the flashcards array
        flashcards = [];
        
        // Update the display
        displayFlashcards();

        // Close the modal
        document.getElementById('discard-modal').classList.add('hidden');
    });
</script>

<style>

    #flashcards-container {
        background-color: #f4f6f5; /* Similar background color */
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
    }

    /* Reset container margins and ensure proper width */
    #flashcards-box {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: hidden; /* Prevent horizontal scroll */
        margin: 0;
        padding: 1rem;
        width: 100%;
        box-sizing: border-box;
        padding-right: 1.5rem;
    }

    /* Grid container with proper spacing */
    #flashcards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        width: 100%;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    /* Individual flashcard styling */
    .flashcard {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 1rem;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        margin: 0; /* Remove any margin */
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        width: 100%;
    }

    .card-label {
        color: #6b8276;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .answer-label {
        color: #6b8276;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }

    .card-content {
        color: #4a5568;
        padding: 0.5rem;
        background-color: #f8f9f8;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        word-wrap: break-word;
        width: 100%;
        box-sizing: border-box;
    }

    .card-content.question {
        border-left: 3px solid #9daca2;
    }

    .card-content.answer {
        border-left: 3px solid #6b8276;
    }

    .card-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
    }

    .control-btn {
        background-color: #9daca2;
        border: none;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s;
    }

    .control-btn:hover {
        background-color: #6b8276;
        cursor: pointer;
    }

    .add-btn {
        background-color: #a2b8d0;
    }

    .delete-btn {
        background-color: #d4a8a8;
    }

    #discard-modal {
        transition: opacity 0.3s ease;
    }

    /* Modal buttons */
    #discard-modal button {
        transition: background-color 0.3s ease;
        cursor: pointer;
        transform: scale(1.05);
    }

    /* Hover effect for Cancel button */
    #discard-modal .bg-gray-300 {
        background-color: #f4f6f5; /* Similar to the light background of the app */
        color: #666;
    }

    /* Hover color for Cancel */
    #discard-modal button:hover {
        background-color: #e1e5e1;
    }

    /* Discard Button with Green Hover */
    #discard-modal .discard-btn {
        background-color: #d4a8a8;
    }

    #discard-modal .discard-btn:hover {
        background-color: #9daca2; /* Green hover color */
    }

    

</style>
{% endblock %}
